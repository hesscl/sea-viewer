---
title: "sea-viewer"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    theme: bootstrap
    logo: logo.svg
    source_code: "https://github.com/hesscl/sea-viewer"
---

```{r setup, echo = FALSE, include = FALSE}
library(flexdashboard)
library(tidyverse)
library(sqldf)
library(lubridate)
library(imputeTS)
library(xts)
library(highcharter)
library(forecast)
library(rgdal)
library(leaflet)
library(zoo)
library(DT)
library(sf)
library(yaml)

#data
#store credentials read in from YAML
cred <- read_yaml("H:/natrent0.yaml")

#create a pool for database connections
DB <- dbConnect(
  drv = RPostgres::Postgres(),
  dbname = "natrent",
  host = "natrent0.csde.washington.edu",
  user = names(cred),
  password = cred[[names(cred)]],
  bigint = "numeric"
)

#query the clean table
cl <- st_read(DB, query = "SELECT * FROM clean WHERE listing_loc_abb = 'sea' AND listing_date >= '2017-02-06'")

#separate the geometry col temporarily since it interferes with dplyr
cl_geo <- cl %>%
  select(seq_id, geometry)

#dedupe and listwise delete
cl <- cl %>%  
  st_drop_geometry() %>%
  mutate(listing_date = as.Date(listing_date),
         listing_moyr = as.Date(as.yearmon(listing_date)),
         cat_beds = NA,
         cat_beds = ifelse(clean_beds %in% 0:4, clean_beds, cat_beds),
         cat_beds = ifelse(clean_beds >= 5, "5+", cat_beds)) %>%
  filter(!is.na(clean_beds), !is.na(clean_rent), !is.na(clean_sqft)) %>%
  filter(listing_date != Sys.Date()) %>% #since day-of is incomplete
  arrange(desc(listing_date)) %>%
  distinct(listing_moyr, match_address, match_address2, clean_beds, clean_sqft, .keep_all = T) 

#restore geometry to table, obj will be sf
cl <- inner_join(cl_geo, cl)

#remove low quality geocode matches
cl <- cl %>%
  filter(!match_type %in% c("No Address Found", "Google Maps Lat/Long"))

#query the tract geography table
wash <- DB %>%
  tbl("tract10") %>%
  filter(statefp10 == "53", countyfp10 == "033") %>%
  collect

cl_crs <- st_crs(cl_geo$geometry)$epsg

#load shapefiles and transform to AEA
sea_shp <- read_sf(dsn = "../data/geo/sea_tract_2010/sea_tract_2010.shp")
sea_shp <- st_transform(sea_shp, cl_crs)
sea_shp <- st_set_crs(sea_shp, cl_crs)

kc_shp <- read_sf(dsn = "../data/geo/KCTract2010/KCTract2010.shp")
kc_shp <- st_transform(kc_shp, cl_crs)
kc_shp <- st_set_crs(kc_shp, cl_crs)

neigh_shp <- read_sf(dsn = "../data/geo/neighborhoods/WGS84/neighborhoods.shp")
neigh_shp <- st_transform(neigh_shp, cl_crs)
neigh_shp <- st_set_crs(neigh_shp, cl_crs)
neigh_shp <- neigh_shp %>%
  mutate(HOOD = ifelse(L_HOOD == "NO BROADER TERM", toupper(S_HOOD), L_HOOD))

#dummy for seattle
cl$seattle <- st_within(cl, sea_shp) %>% lengths > 0 %>% as.numeric()

#append tract IDs
cl <- st_join(cl, kc_shp[, "GISJOIN"])

#append clerk's office neigh defs
cl <- st_join(cl, neigh_shp[,c("L_HOOD", "S_HOOD", "HOOD")])

#remove the geometry from the cl table since agg fields now exist
cl$geometry <- NULL

#convert shapes to WGS84 for mapping with leaflet
sea_shp <- st_transform(sea_shp, 4326)
kc_shp <- st_transform(kc_shp, 4326)
neigh_shp <- st_transform(neigh_shp, 4326)

#functions for widgets
computeListings <- function(x){
  y <- x %>% 
    filter(listing_date %in% seq(Sys.Date()-30, Sys.Date(), by = 1)) %>%
    group_by(listing_date) %>%
    summarize(n = n()) %>%
    summarize(median = median(n)) %>%
    pull(median)
  y <- prettyNum(y, big.mark = ",")
  return(y)
}

computeKCMedian30 <- function(x){
  y <- x %>% 
    filter(listing_date %in% seq(Sys.Date()-30, Sys.Date(), by = 1)) %>%
    filter(seattle == 0) %>%
    summarize(median = median(clean_rent)) %>%
    pull(median)
  y <- prettyNum(y, big.mark = ",")
  return(y)
}

computeSeaMedian30 <- function(x){
  y <- x %>% 
    filter(listing_date %in% seq(Sys.Date()-30, Sys.Date(), by = 1)) %>%
    filter(seattle == 1) %>%
    summarize(median = median(clean_rent)) %>%
    pull(median)
  y <- prettyNum(y, big.mark = ",")
  return(y)
}

#function for Overview graphic
computeTS <- function(x){
  y <- x %>%
    group_by(listing_date) %>%
    filter(clean_beds == 1) %>%
    summarize(median = median(clean_rent))
  
 full_dates <- seq(from = min(y$listing_date), to = max(y$listing_date), by = 1)
 index <- seq(from = 1, length.out = length(full_dates), by = 1)
 dateTable <- cbind.data.frame(full_dates, index)
 
 medRent <- NULL
  for(i in 1:length(full_dates)){
    if(full_dates[i] %in% y$listing_date){
      medRent[i] <- y$median[y$listing_date == full_dates[i]]
    } else{
      medRent[i] <- NA
    }
  }
  ts <- cbind.data.frame(medRent, full_dates)
  ts <- na.interpolation(ts, option = "linear")
  ts <- zoo(ts$medRent, order.by = full_dates) %>% as.xts
  return(ts)
}

compute90 <- function(x){
  y <- x %>%
  filter(listing_date %in% seq(Sys.Date()-91, Sys.Date()-1, 1)) %>%
  group_by(cat_beds) %>%
  summarize(n = n(),
            quant0.025 = prettyNum(round(quantile(clean_rent, .025)), big.mark = ","),
            medRent = prettyNum(round(median(clean_rent)), big.mark = ","),
            quant0.975 = prettyNum(round(quantile(clean_rent, .975)), big.mark = ","),
            medRentPerSqft = prettyNum(round(median(clean_rent/clean_sqft), 2), big.mark = ","))
  return(y)
}

aggTrends <- function(x){
  y <- x %>%
    filter(cat_beds != "5+") %>%
    mutate(listing_moyr = as.Date(as.character(listing_moyr))) %>%
    group_by(listing_moyr, cat_beds) %>%
    summarize(medRent = median(clean_rent),
              n = n())
  return(y)
}

prepShape <- function(x, bed.type = "1", shp = NULL, group = "GISJOIN"){
  y <- cl %>%
    filter(cat_beds == bed.type) %>%
    mutate(GISJOIN = as.character(GISJOIN)) %>%
    group_by_(group) %>% 
    summarize(n = n(),
              medRent = median(clean_rent)) %>%
    filter(n > 15)
  
  shp <- left_join(shp, y)
}

ts_thm <- hc_theme_merge(
  hc_theme_google(),
  hc_theme(colors = RColorBrewer::brewer.pal(3, "Set1")[-1]))

sea_thm <- hc_theme_merge(
  hc_theme_google(),
  hc_theme(colors = RColorBrewer::brewer.pal(5, "Blues")[-1]))

kc_thm <- hc_theme_merge(
  hc_theme_google(),
  hc_theme(colors = RColorBrewer::brewer.pal(5, "Greens")[-1]))

#load SHA VPS table
vps <- read_csv("./sha_vps.csv")

#join to cl
cl <- left_join(cl, vps)
```

Home {data-icon="fa-home"}
=====================================

Row
-------------------------------------

### Welcome!

This website provides the latest information from the UW team's rental market database. The navigation bar provides access to detailed reports for Seattle, King County and specific neighborhoods.

Contact the project team at [searent@uw.edu](mailto://searent@uw.edu) for more information about this report or to suggest new features.


Row
-------------------------------------

### Daily 1-bedroom median rent time-series (90-day rolling average)

```{r overview.ts, echo = FALSE, warning = F, message = F, dpi = 300}
ts <- computeTS(cl %>% filter(seattle == 0))
ts_sea <- computeTS(cl %>% filter(seattle == 1))

ts <- xts(rollapply(as.zoo(ts), FUN = mean, 90, na.rm = T, partial = T))
ts_sea <- xts(rollapply(as.zoo(ts_sea), FUN = mean, 90, na.rm = T, partial = T))

mts <- cbind(ts_sea, ts)

highchart() %>%
  hc_add_series(mts[,1], name = "Seattle") %>%
  hc_add_series(mts[,2], name = "King County") %>%
  hc_yAxis(title = list(text = "Median Listing Rent"), opposite = F) %>%
  hc_xAxis(type = "datetime") %>% 
  hc_tooltip(pointFormat = "<b>{series.name}</b> <br> Rent: {point.y:%.0f}") %>%
  hc_add_theme(ts_thm) %>%
  hc_exporting(enabled = TRUE)

```

Row
-------------------------------------

### Seattle median listings/day (past 30 days)

```{r overview.list}
listings <- computeListings(cl %>% filter(seattle == 1))
valueBox(listings,
         color = "secondary",
         icon = "fa-building")
```

### Seattle median listing rent (past 30 days) 

```{r overview.seamed}
median <- computeSeaMedian30(cl)
valueBox(paste0("\U0024", median), 
         color = "secondary",
         icon = "fa-dollar")
```

### King County median listing rent (past 30 days)

```{r overview.kcmed}
median <- computeKCMedian30(cl)
valueBox(paste0("\U0024", median),
         color = "secondary",
         icon = "fa-dollar")
```



Overview {data-navmenu="Seattle"}
=====================================

Row
-------------------------------------

### 90-day summary for Seattle listings

```{r sea.90day}
DT::datatable(compute90(cl %>% filter(seattle == 1)),
              rownames = F,
              colnames = c("Bedroom Size", "N Listings", "2.5% Quantile", "Median Rent", "97.5% Quantile", "Median Rent/Sqft"),
              class = "cell-border stripe",
              style = "bootstrap",
              autoHideNavigation = T,
              extensions = 'Buttons', 
              options = list(dom = 'Bfrtip',
                             buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                             paging = F,
                             searching = F,
                             autoWidth = T,
                             columnDefs = list(list(className = 'dt-right', targets = 1:5))
))
              
```


Row
-------------------------------------

### Trend analysis

```{r sea.trend}
agg_sea <- aggTrends(cl %>% filter(seattle == 1, cat_beds %in% c("0", "1", "2", "3")))

hchart(agg_sea, type = "line",
       hcaes(x = listing_moyr, y = medRent, group = cat_beds)) %>%
  hc_yAxis(title = list(text = "Median Listing Rent")) %>%
  hc_xAxis(title = list(text = "Month")) %>%
  hc_add_theme(sea_thm)  %>%
  hc_tooltip(pointFormat = "<b>{series.name} Bedroom Units</b> <br> Rent: {point.y:%.0f} <br> N Listings: {point.n}") %>%
  hc_exporting(enabled = TRUE)

```


0B Rent Map  {data-navmenu="Seattle"}
=====================================

```{r, sea.0Bmap, warning = FALSE}
sea_map <- prepShape(x = cl, bed.type = "0", shp = sea_shp)

labels <- sprintf(
  "<strong>%s</strong><br/>Median 0B Rent: %g",
  sea_map$NAMELSAD10, sea_map$medRent
) %>% lapply(htmltools::HTML)

pal <- colorBin("Blues", domain = sea_map$medRent, bins = 6)

leaflet(sea_map) %>%
  setView(lng = -122.332460, lat = 47.610629, zoom = 11) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5, 
              fillColor = ~pal(medRent),
              highlight = highlightOptions(
                              weight = 5,
                              color = "#666",
                              fillOpacity = 0.7,
                              bringToFront = TRUE),
                label = labels,
                labelOptions = labelOptions(
                                    style = list("font-weight" = "normal", padding = "3px 8px"),
                                    textsize = "15px",
                                    direction = "auto")) %>%
  addLegend(pal = pal, values = ~medRent, opacity = 0.7, title = "0B Median Rent",
  position = "bottomright")
```


1B Rent Map  {data-navmenu="Seattle"}
=====================================

```{r, sea.1Bmap, warning = FALSE}
sea_map <- prepShape(x = cl, bed.type = "1", shp = sea_shp)

pal <- colorBin("Blues", domain = sea_map$medRent, bins = 6)

labels <- sprintf(
  "<strong>%s</strong><br/>Median 1B Rent: %g",
  sea_map$NAMELSAD10, sea_map$medRent
) %>% lapply(htmltools::HTML)

leaflet(sea_map) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5, 
              fillColor = ~pal(medRent),
              highlight = highlightOptions(
                              weight = 5,
                              color = "#666",
                              fillOpacity = 0.7,
                              bringToFront = TRUE),
                label = labels,
                labelOptions = labelOptions(
                                    style = list("font-weight" = "normal", padding = "3px 8px"),
                                    textsize = "15px",
                                    direction = "auto")) %>%
  addLegend(pal = pal, values = ~medRent, opacity = 0.7, title = "1B Median Rent",
  position = "bottomright")
```


2B Rent Map  {data-navmenu="Seattle"}
=====================================

```{r, sea.2Bmap, warning = FALSE}
sea_map <- prepShape(x = cl, bed.type = "2", shp = sea_shp)

pal <- colorBin("Blues", domain = sea_map$medRent, bins = 6)

labels <- sprintf(
  "<strong>%s</strong><br/>Median 2B Rent: %g",
  sea_map$NAMELSAD10, sea_map$medRent
) %>% lapply(htmltools::HTML)

leaflet(sea_map) %>%
  setView(lng = -122.332460, lat = 47.610629, zoom = 11) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5, 
              fillColor = ~pal(medRent),
              highlight = highlightOptions(
                              weight = 5,
                              color = "#666",
                              fillOpacity = 0.7,
                              bringToFront = TRUE),
                label = labels,
                labelOptions = labelOptions(
                                    style = list("font-weight" = "normal", padding = "3px 8px"),
                                    textsize = "15px",
                                    direction = "auto")) %>%
  addLegend(pal = pal, values = ~medRent, opacity = 0.7, title = "2B Median Rent",
  position = "bottomright")
```


3B Rent Map  {data-navmenu="Seattle"}
=====================================

```{r sea.3Bmap, warning = FALSE}
sea_map <- prepShape(x = cl, bed.type = "3", shp = sea_shp)

pal <- colorBin("Blues", domain = sea_map$medRent, bins = 6)

labels <- sprintf(
  "<strong>%s</strong><br/>Median 3B Rent: %g",
  sea_map$NAMELSAD10, sea_map$medRent
) %>% lapply(htmltools::HTML)

leaflet(sea_map) %>%
  setView(lng = -122.332460, lat = 47.610629, zoom = 11) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5, 
              fillColor = ~pal(medRent),
              highlight = highlightOptions(
                              weight = 5,
                              color = "#666",
                              fillOpacity = 0.7,
                              bringToFront = TRUE),
                label = labels,
                labelOptions = labelOptions(
                                    style = list("font-weight" = "normal", padding = "3px 8px"),
                                    textsize = "15px",
                                    direction = "auto")) %>%
  addLegend(pal = pal, values = ~medRent, opacity = 0.7, title = "3B Median Rent",
  position = "bottomright")
```


Overview  {data-navmenu="King County"}
=====================================

Row
-------------------------------------

### 90-day summary for King County listings

```{r kc.90day}
DT::datatable(compute90(cl %>% filter(seattle == 0)),
              rownames = F,
              colnames = c("Bedroom Size", "N Listings", "2.5% Quantile", "Median Rent", "97.5% Quantile", "Median Rent/Sqft"),
              class = "cell-border stripe",
              style = "bootstrap",
              autoHideNavigation = T,
              extensions = 'Buttons', 
              options = list(dom = 'Bfrtip',
                             buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                             paging = F,
                             searching = F,
                             autoWidth = T,
                             columnDefs = list(list(className = 'dt-right', targets = 1:5))
))
```


Row
-------------------------------------

### Trend analysis

```{r, kc.trend}
agg_kc <- aggTrends(cl %>% filter(cat_beds %in% c("0", "1", "2", "3", seattle == 0)))

hchart(agg_kc, type = "line",
       hcaes(x = listing_moyr, y = medRent, group = cat_beds)) %>%
  hc_yAxis(title = list(text = "Median Listing Rent")) %>%
  hc_xAxis(title = list(text = "Month")) %>%
  hc_add_theme(kc_thm)  %>%
  hc_tooltip(pointFormat = "<b>{series.name} Bedroom Units</b> <br> Rent: {point.y:%.0f} <br> N Listings: {point.n}") %>%
  hc_exporting(enabled = TRUE)
```


0B Rent Map  {data-navmenu="King County"}
=====================================

```{r, kc.0Bmap, warning = FALSE}
kc_map <- prepShape(x = cl %>% filter(seattle == 0), bed.type = "0", shp = kc_shp)

labels <- sprintf(
  "<strong>%s</strong><br/>Median 0B Rent: %g",
  kc_map$NAMELSAD10, kc_map$medRent
) %>% lapply(htmltools::HTML)

pal <- colorBin("Greens", domain = kc_map$medRent, bins = 6)

leaflet(kc_map) %>%
  setView(lng = -122.332460, lat = 47.610629, zoom = 11) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5, 
              fillColor = ~pal(medRent),
              highlight = highlightOptions(
                              weight = 5,
                              color = "#666",
                              fillOpacity = 0.7,
                              bringToFront = TRUE),
                label = labels,
                labelOptions = labelOptions(
                                    style = list("font-weight" = "normal", padding = "3px 8px"),
                                    textsize = "15px",
                                    direction = "auto")) %>%
  addLegend(pal = pal, values = ~medRent, opacity = 0.7, title = "0B Median Rent",
  position = "bottomright")
```


1B Rent Map  {data-navmenu="King County"}
=====================================

```{r, kc.1Bmap, warning = FALSE}
kc_map <- prepShape(x = cl %>% filter(seattle == 0), bed.type = "1", shp = kc_shp)

pal <- colorBin("Greens", domain = kc_map$medRent, bins = 6)

labels <- sprintf(
  "<strong>%s</strong><br/>Median 1B Rent: %g",
  kc_map$NAMELSAD10, kc_map$medRent
) %>% lapply(htmltools::HTML)

leaflet(kc_map) %>%
  setView(lng = -122.332460, lat = 47.610629, zoom = 11) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5, 
              fillColor = ~pal(medRent),
              highlight = highlightOptions(
                              weight = 5,
                              color = "#666",
                              fillOpacity = 0.7,
                              bringToFront = TRUE),
                label = labels,
                labelOptions = labelOptions(
                                    style = list("font-weight" = "normal", padding = "3px 8px"),
                                    textsize = "15px",
                                    direction = "auto")) %>%
  addLegend(pal = pal, values = ~medRent, opacity = 0.7, title = "1B Median Rent",
  position = "bottomright")
```


2B Rent Map  {data-navmenu="King County"}
=====================================

```{r, kc.2Bmap, warning = FALSE}
kc_map <- prepShape(x = cl %>% filter(seattle == 0), bed.type = "2", shp = kc_shp)

pal <- colorBin("Greens", domain = kc_map$medRent, bins = 6)

labels <- sprintf(
  "<strong>%s</strong><br/>Median 2B Rent: %g",
  kc_map$NAMELSAD10, kc_map$medRent
) %>% lapply(htmltools::HTML)

leaflet(kc_map) %>%
  setView(lng = -122.332460, lat = 47.610629, zoom = 11) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5, 
              fillColor = ~pal(medRent),
              highlight = highlightOptions(
                              weight = 5,
                              color = "#666",
                              fillOpacity = 0.7,
                              bringToFront = TRUE),
                label = labels,
                labelOptions = labelOptions(
                                    style = list("font-weight" = "normal", padding = "3px 8px"),
                                    textsize = "15px",
                                    direction = "auto")) %>%
  addLegend(pal = pal, values = ~medRent, opacity = 0.7, title = "2B Median Rent",
  position = "bottomright")
```


3B Rent Map  {data-navmenu="King County"}
=====================================

```{r kc.3Bmap, warning = FALSE}
kc_map <- prepShape(x = cl %>% filter(seattle == 0), bed.type = "3", shp = kc_shp)

pal <- colorBin("Greens", domain = kc_map$medRent, bins = 6)

labels <- sprintf(
  "<strong>%s</strong><br/>Median 3B Rent: %g",
  kc_map$NAMELSAD10, kc_map$medRent
) %>% lapply(htmltools::HTML)

leaflet(kc_map) %>%
  setView(lng = -122.332460, lat = 47.610629, zoom = 11) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5, 
              fillColor = ~pal(medRent),
              highlight = highlightOptions(
                              weight = 5,
                              color = "#666",
                              fillOpacity = 0.7,
                              bringToFront = TRUE),
                label = labels,
                labelOptions = labelOptions(
                                    style = list("font-weight" = "normal", padding = "3px 8px"),
                                    textsize = "15px",
                                    direction = "auto")) %>%
  addLegend(pal = pal, values = ~medRent, opacity = 0.7, title = "3B Median Rent",
  position = "bottomright")
```

1B Map {data-navmenu="Neighborhoods"}
=====================================

```{r, neigh.1Bmap, warning = FALSE}
neigh_map <- prepShape(x = cl, bed.type = "1", shp = neigh_shp, group = "HOOD")

pal <- colorBin("Blues", domain = neigh_map$medRent, bins = 6)

labels <- sprintf(
  "<strong>%s</strong><br/>Median 1B Rent: %g",
  neigh_map$HOOD, neigh_map$medRent
) %>% lapply(htmltools::HTML)

leaflet(neigh_map) %>%
  setView(lng = -122.332460, lat = 47.610629, zoom = 11) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.5, 
              fillColor = ~pal(medRent),
              highlight = highlightOptions(
                              weight = 5,
                              color = "#666",
                              fillOpacity = 0.7,
                              bringToFront = TRUE),
                label = labels,
                labelOptions = labelOptions(
                                    style = list("font-weight" = "normal", padding = "3px 8px"),
                                    textsize = "15px",
                                    direction = "auto")) %>%
  addLegend(pal = pal, values = ~medRent, opacity = 0.7, title = "1B Median Rent",
  position = "bottomright")
```


Ballard {data-navmenu="Neighborhoods"}
=====================================

Row
-------------------------------------

### 90-day summary

```{r ballard.90day}
DT::datatable(compute90(cl %>% filter(L_HOOD == "BALLARD")),
              rownames = F,
              colnames = c("Bedroom Size", "N Listings", "2.5% Quantile", "Median Rent", "97.5% Quantile", "Median Rent/Sqft"),
              class = "cell-border stripe",
              style = "bootstrap",
              autoHideNavigation = T,
              extensions = 'Buttons', 
              options = list(dom = 'Bfrtip',
                             buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                             paging = F,
                             searching = F,
                             autoWidth = T,
                             columnDefs = list(list(className = 'dt-right', targets = 1:5))
))
              
```

Row
-------------------------------------

### Trend Analysis

```{r ballard.trend}
agg_ball <- aggTrends(cl %>% filter(L_HOOD == "BALLARD", cat_beds %in% c("0", "1", "2")))

hchart(agg_ball, type = "line",
       hcaes(x = listing_moyr, y = medRent, group = cat_beds)) %>%
  hc_yAxis(title = list(text = "Median Listing Rent")) %>%
  hc_xAxis(title = list(text = "Month")) %>%
  hc_add_theme(sea_thm)  %>%
  hc_tooltip(pointFormat = "<b>{series.name} Bedroom Units</b> <br> Rent: {point.y:%.0f} <br> N Listings: {point.n}") %>%
  hc_exporting(enabled = TRUE)
```



Beacon Hill {data-navmenu="Neighborhoods"}
=====================================

Row
-------------------------------------

### 90-day summary

```{r beacon.90day}
DT::datatable(compute90(cl %>% filter(L_HOOD == "BEACON HILL")),
              rownames = F,
              colnames = c("Bedroom Size", "N Listings", "2.5% Quantile", "Median Rent", "97.5% Quantile", "Median Rent/Sqft"),
              class = "cell-border stripe",
              style = "bootstrap",
              autoHideNavigation = T,
              extensions = 'Buttons', 
              options = list(dom = 'Bfrtip',
                             buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                             paging = F,
                             searching = F,
                             autoWidth = T,
                             columnDefs = list(list(className = 'dt-right', targets = 1:5))
))
              
```

Row
-------------------------------------

### Trend Analysis

```{r beacon.trend}
agg_beac <- aggTrends(cl %>% filter(L_HOOD == "BEACON HILL", cat_beds %in% c("0", "1", "2")))

hchart(agg_beac, type = "line",
       hcaes(x = listing_moyr, y = medRent, group = cat_beds)) %>%
  hc_yAxis(title = list(text = "Median Listing Rent")) %>%
  hc_xAxis(title = list(text = "Month")) %>%
  hc_add_theme(sea_thm)  %>%
  hc_tooltip(pointFormat = "<b>{series.name} Bedroom Units</b> <br> Rent: {point.y:%.0f} <br> N Listings: {point.n}") %>%
  hc_exporting(enabled = TRUE)
```


Capitol Hill {data-navmenu="Neighborhoods"}
=====================================

Row
-------------------------------------

### 90-day summary

```{r capitol.90day}
DT::datatable(compute90(cl %>% filter(L_HOOD == "CAPITOL HILL")),
              rownames = F,
              colnames = c("Bedroom Size", "N Listings", "2.5% Quantile", "Median Rent", "97.5% Quantile", "Median Rent/Sqft"),
              class = "cell-border stripe",
              style = "bootstrap",
              autoHideNavigation = T,
              extensions = 'Buttons', 
              options = list(dom = 'Bfrtip',
                             buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                             paging = F,
                             searching = F,
                             autoWidth = T,
                             columnDefs = list(list(className = 'dt-right', targets = 1:5))
))
              
```

Row
-------------------------------------

### Trend Analysis

```{r capitol.trend}
agg_cap <- aggTrends(cl %>% filter(L_HOOD == "CAPITOL HILL", cat_beds %in% c("0", "1", "2")))

hchart(agg_cap, type = "line",
       hcaes(x = listing_moyr, y = medRent, group = cat_beds)) %>%
  hc_yAxis(title = list(text = "Median Listing Rent")) %>%
  hc_xAxis(title = list(text = "Month")) %>%
  hc_add_theme(sea_thm)  %>%
  hc_tooltip(pointFormat = "<b>{series.name} Bedroom Units</b> <br> Rent: {point.y:%.0f} <br> N Listings: {point.n}") %>%
  hc_exporting(enabled = TRUE)
```

Central District {data-navmenu="Neighborhoods"}
=====================================

Row
-------------------------------------

### 90-day summary

```{r central.90day}
DT::datatable(compute90(cl %>% filter(L_HOOD == "CENTRAL AREA")),
              rownames = F,
              colnames = c("Bedroom Size", "N Listings", "2.5% Quantile", "Median Rent", "97.5% Quantile", "Median Rent/Sqft"),
              class = "cell-border stripe",
              style = "bootstrap",
              autoHideNavigation = T,
              extensions = 'Buttons', 
              options = list(dom = 'Bfrtip',
                             buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                             paging = F,
                             searching = F,
                             autoWidth = T,
                             columnDefs = list(list(className = 'dt-right', targets = 1:5))
))
              
```

Row
-------------------------------------

### Trend Analysis

```{r central.trend}
agg_cent <- aggTrends(cl %>% filter(L_HOOD == "CENTRAL AREA", cat_beds %in% c("0", "1", "2")))

hchart(agg_cent, type = "line",
       hcaes(x = listing_moyr, y = medRent, group = cat_beds)) %>%
  hc_yAxis(title = list(text = "Median Listing Rent")) %>%
  hc_xAxis(title = list(text = "Month")) %>%
  hc_add_theme(sea_thm)  %>%
  hc_tooltip(pointFormat = "<b>{series.name} Bedroom Units</b> <br> Rent: {point.y:%.0f} <br> N Listings: {point.n}") %>%
  hc_exporting(enabled = TRUE)
```


Delridge {data-navmenu="Neighborhoods"}
=====================================


Row
-------------------------------------

### 90-day summary

```{r delridge.90day}
DT::datatable(compute90(cl %>% filter(L_HOOD == "DELRIDGE")),
              rownames = F,
              colnames = c("Bedroom Size", "N Listings", "2.5% Quantile", "Median Rent", "97.5% Quantile", "Median Rent/Sqft"),
              class = "cell-border stripe",
              style = "bootstrap",
              autoHideNavigation = T,
              extensions = 'Buttons', 
              options = list(dom = 'Bfrtip',
                             buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                             paging = F,
                             searching = F,
                             autoWidth = T,
                             columnDefs = list(list(className = 'dt-right', targets = 1:5))
))
              
```

Row
-------------------------------------

### Trend Analysis

```{r delridge.trend}
agg_del <- aggTrends(cl %>% filter(L_HOOD == "DELRIDGE", cat_beds %in% c("0", "1", "2")))

hchart(agg_del, type = "line",
       hcaes(x = listing_moyr, y = medRent, group = cat_beds)) %>%
  hc_yAxis(title = list(text = "Median Listing Rent")) %>%
  hc_xAxis(title = list(text = "Month")) %>%
  hc_add_theme(sea_thm)  %>%
  hc_tooltip(pointFormat = "<b>{series.name} Bedroom Units</b> <br> Rent: {point.y:%.0f} <br> N Listings: {point.n}") %>%
  hc_exporting(enabled = TRUE)
```




Downtown {data-navmenu="Neighborhoods"}
=====================================

Row
-------------------------------------

### 90-day summary

```{r downtown.90day}
DT::datatable(compute90(cl %>% filter(L_HOOD == "DOWNTOWN")),
              rownames = F,
              colnames = c("Bedroom Size", "N Listings", "2.5% Quantile", "Median Rent", "97.5% Quantile", "Median Rent/Sqft"),
              class = "cell-border stripe",
              style = "bootstrap",
              autoHideNavigation = T,
              extensions = 'Buttons', 
              options = list(dom = 'Bfrtip',
                             buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                             paging = F,
                             searching = F,
                             autoWidth = T,
                             columnDefs = list(list(className = 'dt-right', targets = 1:5))
))
              
```

Row
-------------------------------------

### Trend Analysis

```{r downtown.trend}
agg_down <- aggTrends(cl %>% filter(L_HOOD == "DOWNTOWN", cat_beds %in% c("0", "1", "2")))

hchart(agg_down, type = "line",
       hcaes(x = listing_moyr, y = medRent, group = cat_beds)) %>%
  hc_yAxis(title = list(text = "Median Listing Rent")) %>%
  hc_xAxis(title = list(text = "Month")) %>%
  hc_add_theme(sea_thm)  %>%
  hc_tooltip(pointFormat = "<b>{series.name} Bedroom Units</b> <br> Rent: {point.y:%.0f} <br> N Listings: {point.n}") %>%
  hc_exporting(enabled = TRUE)
```




Lake City {data-navmenu="Neighborhoods"}
=====================================

Row
-------------------------------------

### 90-day summary

```{r lakecity.90day}
DT::datatable(compute90(cl %>% filter(L_HOOD == "LAKE CITY")),
              rownames = F,
              colnames = c("Bedroom Size", "N Listings", "2.5% Quantile", "Median Rent", "97.5% Quantile", "Median Rent/Sqft"),
              class = "cell-border stripe",
              style = "bootstrap",
              autoHideNavigation = T,
              extensions = 'Buttons', 
              options = list(dom = 'Bfrtip',
                             buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                             paging = F,
                             searching = F,
                             autoWidth = T,
                             columnDefs = list(list(className = 'dt-right', targets = 1:5))
))
              
```

Row
-------------------------------------

### Trend Analysis

```{r lakecity.trend}
agg_lake <- aggTrends(cl %>% filter(L_HOOD == "LAKE CITY", cat_beds %in% c("0", "1", "2")))

hchart(agg_lake, type = "line",
       hcaes(x = listing_moyr, y = medRent, group = cat_beds)) %>%
  hc_yAxis(title = list(text = "Median Listing Rent")) %>%
  hc_xAxis(title = list(text = "Month")) %>%
  hc_add_theme(sea_thm)  %>%
  hc_tooltip(pointFormat = "<b>{series.name} Bedroom Units</b> <br> Rent: {point.y:%.0f} <br> N Listings: {point.n}") %>%
  hc_exporting(enabled = TRUE)
```

Magnolia {data-navmenu="Neighborhoods"}
=====================================

Row
-------------------------------------

### 90-day summary

```{r magnolia.90day}
DT::datatable(compute90(cl %>% filter(L_HOOD == "MAGNOLIA")),
              rownames = F,
              colnames = c("Bedroom Size", "N Listings", "2.5% Quantile", "Median Rent", "97.5% Quantile", "Median Rent/Sqft"),
              class = "cell-border stripe",
              style = "bootstrap",
              autoHideNavigation = T,
              extensions = 'Buttons', 
              options = list(dom = 'Bfrtip',
                             buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                             paging = F,
                             searching = F,
                             autoWidth = T,
                             columnDefs = list(list(className = 'dt-right', targets = 1:5))
))
              
```

Row
-------------------------------------

### Trend Analysis

```{r magnolia.trend}
agg_magnolia <- aggTrends(cl %>% filter(L_HOOD == "MAGNOLIA", cat_beds %in% c("0", "1", "2")))

hchart(agg_magnolia, type = "line",
       hcaes(x = listing_moyr, y = medRent, group = cat_beds)) %>%
  hc_yAxis(title = list(text = "Median Listing Rent")) %>%
  hc_xAxis(title = list(text = "Month")) %>%
  hc_add_theme(sea_thm)  %>%
  hc_tooltip(pointFormat = "<b>{series.name} Bedroom Units</b> <br> Rent: {point.y:%.0f} <br> N Listings: {point.n}") %>%
  hc_exporting(enabled = TRUE)
```




Northgate {data-navmenu="Neighborhoods"}
=====================================

Row
-------------------------------------

### 90-day summary

```{r northgate.90day}
DT::datatable(compute90(cl %>% filter(L_HOOD == "NORTHGATE")),
              rownames = F,
              colnames = c("Bedroom Size", "N Listings", "2.5% Quantile", "Median Rent", "97.5% Quantile", "Median Rent/Sqft"),
              class = "cell-border stripe",
              style = "bootstrap",
              autoHideNavigation = T,
              extensions = 'Buttons', 
              options = list(dom = 'Bfrtip',
                             buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                             paging = F,
                             searching = F,
                             autoWidth = T,
                             columnDefs = list(list(className = 'dt-right', targets = 1:5))
))
              
```

Row
-------------------------------------

### Trend Analysis

```{r northgate.trend}
agg_north <- aggTrends(cl %>% filter(L_HOOD == "NORTHGATE", cat_beds %in% c("0", "1", "2")))

hchart(agg_north, type = "line",
       hcaes(x = listing_moyr, y = medRent, group = cat_beds)) %>%
  hc_yAxis(title = list(text = "Median Listing Rent")) %>%
  hc_xAxis(title = list(text = "Month")) %>%
  hc_add_theme(sea_thm)  %>%
  hc_tooltip(pointFormat = "<b>{series.name} Bedroom Units</b> <br> Rent: {point.y:%.0f} <br> N Listings: {point.n}") %>%
  hc_exporting(enabled = TRUE)
```


Queen Anne {data-navmenu="Neighborhoods"}
=====================================

Row
-------------------------------------

### 90-day summary

```{r queenanne.90day}
DT::datatable(compute90(cl %>% filter(L_HOOD == "QUEEN ANNE")),
              rownames = F,
              colnames = c("Bedroom Size", "N Listings", "2.5% Quantile", "Median Rent", "97.5% Quantile", "Median Rent/Sqft"),
              class = "cell-border stripe",
              style = "bootstrap",
              autoHideNavigation = T,
              extensions = 'Buttons', 
              options = list(dom = 'Bfrtip',
                             buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                             paging = F,
                             searching = F,
                             autoWidth = T,
                             columnDefs = list(list(className = 'dt-right', targets = 1:5))
))
              
```

Row
-------------------------------------

### Trend Analysis

```{r queenanne.trend}
agg_queen <- aggTrends(cl %>% filter(L_HOOD == "QUEEN ANNE", cat_beds %in% c("0", "1", "2")))

hchart(agg_queen, type = "line",
       hcaes(x = listing_moyr, y = medRent, group = cat_beds)) %>%
  hc_yAxis(title = list(text = "Median Listing Rent")) %>%
  hc_xAxis(title = list(text = "Month")) %>%
  hc_add_theme(sea_thm)  %>%
  hc_tooltip(pointFormat = "<b>{series.name} Bedroom Units</b> <br> Rent: {point.y:%.0f} <br> N Listings: {point.n}") %>%
  hc_exporting(enabled = TRUE)
```

Rainier Valley {data-navmenu="Neighborhoods"}
=====================================

Row
-------------------------------------

### 90-day summary

```{r rainier.90day}
DT::datatable(compute90(cl %>% filter(L_HOOD == "RAINIER VALLEY")),
              rownames = F,
              colnames = c("Bedroom Size", "N Listings", "2.5% Quantile", "Median Rent", "97.5% Quantile", "Median Rent/Sqft"),
              class = "cell-border stripe",
              style = "bootstrap",
              autoHideNavigation = T,
              extensions = 'Buttons', 
              options = list(dom = 'Bfrtip',
                             buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                             paging = F,
                             searching = F,
                             autoWidth = T,
                             columnDefs = list(list(className = 'dt-right', targets = 1:5))
))
              
```

Row
-------------------------------------

### Trend Analysis

```{r rainier.trend}
agg_rainier <- aggTrends(cl %>% filter(L_HOOD == "RAINIER VALLEY", cat_beds %in% c("0", "1", "2")))

hchart(agg_rainier, type = "line",
       hcaes(x = listing_moyr, y = medRent, group = cat_beds)) %>%
  hc_yAxis(title = list(text = "Median Listing Rent")) %>%
  hc_xAxis(title = list(text = "Month")) %>%
  hc_add_theme(sea_thm)  %>%
  hc_tooltip(pointFormat = "<b>{series.name} Bedroom Units</b> <br> Rent: {point.y:%.0f} <br> N Listings: {point.n}") %>%
  hc_exporting(enabled = TRUE) 
```

Seward Park {data-navmenu="Neighborhoods"}
=====================================

Row
-------------------------------------

### 90-day summary

```{r seward.90day}
DT::datatable(compute90(cl %>% filter(L_HOOD == "SEWARD PARK")),
              rownames = F,
              colnames = c("Bedroom Size", "N Listings", "2.5% Quantile", "Median Rent", "97.5% Quantile", "Median Rent/Sqft"),
              class = "cell-border stripe",
              style = "bootstrap",
              autoHideNavigation = T,
              extensions = 'Buttons', 
              options = list(dom = 'Bfrtip',
                             buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                             paging = F,
                             searching = F,
                             autoWidth = T,
                             columnDefs = list(list(className = 'dt-right', targets = 1:5))
))
              
```

Row
-------------------------------------

### Trend Analysis

```{r seward.trend}
agg_seward <- aggTrends(cl %>% filter(L_HOOD == "SEWARD PARK", cat_beds %in% c("0", "1", "2", "3")))

hchart(agg_seward, type = "line",
       hcaes(x = listing_moyr, y = medRent, group = cat_beds)) %>%
  hc_yAxis(title = list(text = "Median Listing Rent")) %>%
  hc_xAxis(title = list(text = "Month")) %>%
  hc_add_theme(sea_thm)  %>%
  hc_tooltip(pointFormat = "<b>{series.name} Bedroom Units</b> <br> Rent: {point.y:%.0f} <br> N Listings: {point.n}") %>%
  hc_exporting(enabled = TRUE) 
```

University District {data-navmenu="Neighborhoods"}
=====================================

Row
-------------------------------------

### 90-day summary

```{r udistrict.90day}
DT::datatable(compute90(cl %>% filter(L_HOOD == "UNIVERSITY DISTRICT")),
              rownames = F,
              colnames = c("Bedroom Size", "N Listings", "2.5% Quantile", "Median Rent", "97.5% Quantile", "Median Rent/Sqft"),
              class = "cell-border stripe",
              style = "bootstrap",
              autoHideNavigation = T,
              extensions = 'Buttons', 
              options = list(dom = 'Bfrtip',
                             buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                             paging = F,
                             searching = F,
                             autoWidth = T,
                             columnDefs = list(list(className = 'dt-right', targets = 1:5))
))
              
```

Row
-------------------------------------

### Trend Analysis

```{r udistrict.trend}
agg_udist <- aggTrends(cl %>% filter(L_HOOD == "UNIVERSITY DISTRICT", cat_beds %in% c("0", "1", "2")))

hchart(agg_udist, type = "line",
       hcaes(x = listing_moyr, y = medRent, group = cat_beds)) %>%
  hc_yAxis(title = list(text = "Median Listing Rent")) %>%
  hc_xAxis(title = list(text = "Month")) %>%
  hc_add_theme(sea_thm)  %>%
  hc_tooltip(pointFormat = "<b>{series.name} Bedroom Units</b> <br> Rent: {point.y:%.0f} <br> N Listings: {point.n}") %>%
  hc_exporting(enabled = TRUE) 
```


West Seattle {data-navmenu="Neighborhoods"}
=====================================

Row
-------------------------------------

### 90-day summary

```{r west.90day}
DT::datatable(compute90(cl %>% filter(L_HOOD == "WEST SEATTLE")),
              rownames = F,
              colnames = c("Bedroom Size", "N Listings", "2.5% Quantile", "Median Rent", "97.5% Quantile", "Median Rent/Sqft"),
              class = "cell-border stripe",
              style = "bootstrap",
              autoHideNavigation = T,
              extensions = 'Buttons', 
              options = list(dom = 'Bfrtip',
                             buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                             paging = F,
                             searching = F,
                             autoWidth = T,
                             columnDefs = list(list(className = 'dt-right', targets = 1:5))
))
```

Row
-------------------------------------

### Trend Analysis

```{r west.trend}
agg_west <- aggTrends(cl %>% filter(L_HOOD == "WEST SEATTLE", cat_beds %in% c("0", "1", "2")))

hchart(agg_west, type = "line",
       hcaes(x = listing_moyr, y = medRent, group = cat_beds)) %>%
  hc_yAxis(title = list(text = "Median Listing Rent")) %>%
  hc_xAxis(title = list(text = "Month")) %>%
  hc_add_theme(sea_thm)  %>%
  hc_tooltip(pointFormat = "<b>{series.name} Bedroom Units</b> <br> Rent: {point.y:%.0f} <br> N Listings: {point.n}") %>%
  hc_exporting(enabled = TRUE) 
```



VPS {data-navmenu="SHA"}
=====================================

Row
-------------------------------------

### 90-day summary

```{r vps.90day}
sum_vps_cov_90 <- cl %>%
  filter(clean_beds <= 5, listing_date %in% seq(Sys.Date()-91, Sys.Date()-1, 1)) %>%
  group_by(clean_beds) %>%
  summarize(n = n(),
            n_covered_fmr = sum(fmr_2018 >= clean_rent),
            n_covered_fmr_90pct = sum(fmr_2018_90pct >= clean_rent)) %>%
  mutate(pct_covered_fmr = round(n_covered_fmr/n, 4)*100,
         pct_covered_fmr_90pct = round(n_covered_fmr_90pct/n, 4)*100)

DT::datatable(sum_vps_cov_90,
              rownames = F,
              colnames = c("Bedroom Size", "N", "N Covered by FMR", "N Covered by 90% FMR", "% Covered by FMR", "% Covered by 90% FMR"),
              class = "cell-border stripe",
              style = "bootstrap",
              autoHideNavigation = T,
              extensions = 'Buttons', 
              options = list(dom = 'Bfrtip',
                             buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                             paging = F,
                             searching = F,
                             autoWidth = T,
                             columnDefs = list(list(className = 'dt-right', targets = 1:5))
))
```

Row
-------------------------------------

### FMR Trend analysis

```{r vps.trend}
#expand the palette length
sea_thm <- hc_theme_merge(
  hc_theme_google(),
  hc_theme(colors = RColorBrewer::brewer.pal(5, "Blues")))

sum_vps_cov <- cl %>%
  filter(clean_beds < 5) %>%
  group_by(listing_moyr, clean_beds) %>%
  summarize(n = n(),
            n_covered_fmr = sum(fmr_2018 >= clean_rent),
            n_covered_fmr_90pct = sum(fmr_2018_90pct >= clean_rent)) %>%
  mutate(pct_covered_fmr = round(n_covered_fmr/n, 4)*100,
         pct_covered_fmr_90pct = round(n_covered_fmr_90pct/n, 4)*100)

hchart(sum_vps_cov, type = "line",
       hcaes(x = listing_moyr, y = pct_covered_fmr, group = clean_beds)) %>%
  hc_yAxis(title = list(text = "Coverage by FMR")) %>%
  hc_xAxis(title = list(text = "Month")) %>%
  hc_add_theme(sea_thm)  %>%
  hc_tooltip(pointFormat = "<b>{series.name} Bedroom Units</b> <br> % Covered: {point.y:%.0f} <br> N Listings: {point.n}") %>%  
  hc_exporting(enabled = TRUE)
```

### 90% FMR Trend analysis

```{r}
sum_vps_cov <- cl %>%
  filter(clean_beds < 5) %>%
  group_by(listing_moyr, clean_beds) %>%
  summarize(n = n(),
            n_covered_fmr = sum(fmr_2018 >= clean_rent),
            n_covered_fmr_90pct = sum(fmr_2018_90pct >= clean_rent)) %>%
  mutate(pct_covered_fmr = round(n_covered_fmr/n, 4)*100,
         pct_covered_fmr_90pct = round(n_covered_fmr_90pct/n, 4)*100)

hchart(sum_vps_cov, type = "line",
       hcaes(x = listing_moyr, y = pct_covered_fmr_90pct, group = clean_beds)) %>%
  hc_yAxis(title = list(text = "Coverage by 90% FMR")) %>%
  hc_xAxis(title = list(text = "Month")) %>%
  hc_add_theme(sea_thm)  %>%
  hc_tooltip(pointFormat = "<b>{series.name} Bedroom Units</b> <br> % Covered: {point.y:%.0f} <br> N Listings: {point.n}") %>%  
  hc_exporting(enabled = TRUE)
```

